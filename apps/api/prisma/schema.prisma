// Prisma Schema for Ayphen TalentX
// Database: PostgreSQL with pgvector extension

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  RECRUITER
  HIRING_MANAGER
  INTERVIEWER
  HR
  EMPLOYEE
  CANDIDATE
  VENDOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum JobStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  OPEN
  ON_HOLD
  CLOSED
  CANCELLED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  TEMPORARY
}

enum WorkLocation {
  ONSITE
  REMOTE
  HYBRID
}

enum ApplicationStatus {
  APPLIED
  SCREENING
  PHONE_SCREEN
  INTERVIEW
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
}

enum InterviewType {
  PHONE_SCREEN
  VIDEO
  ONSITE
  TECHNICAL
  BEHAVIORAL
  PANEL
}

enum InterviewStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum OfferStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  WITHDRAWN
}

// ============================================
// CORE ENTITIES
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  stripeCustomerId String?
  logo      String?
  status    String   @default("ACTIVE") // ACTIVE, SUSPENDED, PENDING
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users        User[]
  jobs         Job[]
  candidates   Candidate[]
  pipelines    Pipeline[]
  departments  Department[]
  locations    Location[]
  jobTemplates JobTemplate[]
  offerTemplates OfferTemplate[]
  savedViews   SavedView[]
  settingsList Setting[]
  skills       Skill[]
  onboardingWorkflows OnboardingWorkflow[]
  emailTemplates EmailTemplate[]
  emails       Email[]
  scorecardTemplates ScorecardTemplate[]
  roles        Role[]
  esignatureSettings ESignatureSettings?
  bgvSettings  BGVSettings?
  subscription Subscription?
  supportTickets SupportTicket[]
  apiKeys        ApiKey[]
  webhookSubscriptions WebhookSubscription[]
  apiUsage       ApiUsage[]

  @@index([status])
  @@map("tenants")
}

model User {
  id           String     @id @default(uuid())
  employeeId   String?    @unique
  email        String
  passwordHash String?
  firstName    String
  lastName     String
  avatar       String?
  role         UserRole   @default(RECRUITER)
  status       UserStatus @default(PENDING)
  phone        String?
  title        String?
  lastLoginAt  DateTime?
  mfaEnabled   Boolean    @default(false)
  mfaSecret    String?
  requirePasswordChange Boolean @default(false)
  tempPasswordExpiresAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  // Jobs where user is hiring manager
  managedJobs Job[] @relation("HiringManager")

  // Jobs where user is recruiter
  recruitedJobs Job[] @relation("Recruiter")

  // Applications assigned to user
  assignedApplications Application[]

  // Interviews as interviewer
  interviews Interview[]

  // Job Approvals
  jobApprovals JobApproval[] @relation("JobApprover")

  // Offer Approvals
  offerApprovals OfferApproval[] @relation("OfferApprover")

  // Feedback given
  feedbacks InterviewFeedback[]

  // Activity logs
  activityLogs ActivityLog[]

  // Refresh tokens
  refreshTokens RefreshToken[]

  // Password reset tokens
  passwordResetTokens PasswordResetToken[]

  // Password history
  passwordHistory PasswordHistory[]

  supportTickets SupportTicket[]
  supportMessages SupportTicketMessage[]

  // User sessions
  sessions UserSession[]

  // User preferences
  preferredTheme    String @default("system")
  preferredLanguage String @default("en")

  savedViews SavedView[]
  
  // Referrals
  referredCandidates Candidate[] @relation("CandidateReferrer")

  // Availability
  availability AvailabilitySlot[]

  // Emails
  emails Email[]
  emailTemplates EmailTemplate[]

  // Permissions
  customPermissions String[] // List of permission strings. If set, overrides role defaults or adds to them.
  roleId            String?
  roleDef           Role?     @relation(fields: [roleId], references: [id])

  // Calendar Integration
  calendarConnections CalendarConnection[]
  calendarEvents      CalendarEvent[]

  // BGV
  bgvChecksInitiated BGVCheck[]

  // Notifications
  notifications           Notification[]
  notificationPreferences NotificationPreference?

  // Saved jobs
  savedJobs SavedJob[]

  // Announcements
  readAnnouncements AnnouncementReadStatus[]

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String
  description String?
  isSystem    Boolean  @default(false)
  permissions String[] // List of permission strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  users User[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("roles")
}

model SavedJob {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@map("saved_jobs")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model MagicLink {
  id        String   @id @default(uuid())
  token     String   @unique
  email     String
  tenantId  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email, tenantId])
  @@map("magic_links")
}

model OtpCode {
  id        String   @id @default(uuid())
  code      String
  email     String
  tenantId  String
  type      String   @default("LOGIN") // LOGIN, PASSWORD_RESET, EMAIL_VERIFY
  expiresAt DateTime
  usedAt    DateTime?
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([email, tenantId, type])
  @@map("otp_codes")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

model PasswordHistory {
  id           String   @id @default(uuid())
  passwordHash String
  createdAt    DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_history")
}

model UserSession {
  id           String    @id @default(uuid())
  sessionToken String    @unique
  userAgent    String?
  ipAddress    String?
  lastActiveAt DateTime  @default(now())
  expiresAt    DateTime
  createdAt    DateTime  @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("user_sessions")
}

model LoginAttempt {
  id        String   @id @default(uuid())
  email     String
  tenantId  String
  ipAddress String?
  success   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, tenantId])
  @@index([ipAddress])
  @@map("login_attempts")
}

model Department {
  id        String   @id @default(uuid())
  name      String
  code      String?
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Self-relation for hierarchy
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children Department[] @relation("DepartmentHierarchy")

  users User[]
  jobs  Job[]

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("departments")
}

model Location {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  state     String?
  country   String
  timezone  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  jobs Job[]

  @@index([tenantId])
  @@map("locations")
}

// ============================================
// JOB MANAGEMENT
// ============================================

model Job {
  id              String         @id @default(uuid())
  jobCode         String?        @unique // e.g. JOB-123456
  title           String
  description     String         @db.Text
  requirements    String?        @db.Text
  responsibilities String?       @db.Text
  benefits        String?        @db.Text
  status          JobStatus      @default(DRAFT)
  employmentType  EmploymentType @default(FULL_TIME)
  duration        String?
  durationUnit    String?
  workLocation    WorkLocation   @default(ONSITE)
  salaryMin       Decimal?       @db.Decimal(12, 2)
  salaryMax       Decimal?       @db.Decimal(12, 2)
  salaryCurrency  String         @default("USD")
  showSalary      Boolean        @default(false)
  openings        Int            @default(1)
  skills          String[]
  experience      String?
  education       String?
  customFields    Json?
  internalOnly    Boolean        @default(false)
  publishedAt     DateTime?
  closesAt        DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  hiringManagerId String?
  hiringManager   User?   @relation("HiringManager", fields: [hiringManagerId], references: [id])

  recruiterId String?
  recruiter   User?   @relation("Recruiter", fields: [recruiterId], references: [id])

  pipelineId String?
  pipeline   Pipeline? @relation(fields: [pipelineId], references: [id])

  applications Application[]
  approvals    JobApproval[]

  scorecardTemplateId String?
  scorecardTemplate   ScorecardTemplate? @relation(fields: [scorecardTemplateId], references: [id])

  savedByUsers SavedJob[]

  // Vector embedding for semantic search
  embedding Unsupported("vector(1536)")?

  @@index([tenantId])
  @@index([status])
  @@index([departmentId])
  @@map("jobs")
}

model JobTemplate {
  id              String         @id @default(uuid())
  name            String
  title           String
  description     String         @db.Text
  requirements    String?        @db.Text
  responsibilities String?       @db.Text
  benefits        String?        @db.Text
  employmentType  EmploymentType @default(FULL_TIME)
  skills          String[]
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("job_templates")
}

model ScorecardTemplate {
  id                    String   @id @default(uuid())
  name                  String
  sections              Json     // Array of sections with criteria
  ratingScale           Int      @default(5)
  ratingLabelMin        String?  @default("Poor")
  ratingLabelMax        String?  @default("Excellent")
  recommendationOptions Json?    // Store string[]
  isActive              Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  jobs     Job[]

  @@index([tenantId])
  @@map("scorecard_templates")
}

model OfferTemplate {
  id        String   @id @default(uuid())
  name      String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  offers    Offer[]

  @@index([tenantId])
  @@map("offer_templates")
}

model JobApproval {
  id         String    @id @default(uuid())
  order      Int
  status     String    @default("PENDING") // PENDING, APPROVED, REJECTED
  comment    String?
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  jobId      String
  job        Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  approverId String
  approver   User   @relation("JobApprover", fields: [approverId], references: [id])

  @@index([jobId])
  @@map("job_approvals")
}

// ============================================
// CANDIDATE MANAGEMENT
// ============================================

model Candidate {
  id             String   @id @default(uuid())
  candidateId    String?  @unique
  email          String
  firstName      String
  lastName       String
  phone          String?
  linkedinUrl    String?
  portfolioUrl   String?
  currentTitle   String?
  currentCompany String?
  location       String?
  summary        String?  @db.Text
  skills         String[]
  experience     Json?    // Structured work history
  education      Json?    // Structured education
  customFieldValues Json? // Custom field values from settings
  resumeUrl      String?
  resumeText     String?  @db.Text
  source         String?  // Where they came from
  sourceDetails  String?
  gdprConsent    Boolean  @default(false)
  gdprConsentAt  DateTime?
  tags           String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  referrerId String?
  referrer   User?   @relation("CandidateReferrer", fields: [referrerId], references: [id])

  applications Application[]
  activities   ActivityLog[]
  emails       Email[]
  bgvChecks    BGVCheck[]
  emailTrackingEvents EmailTrackingEvent[]

  // Vector embedding for semantic search
  embedding Unsupported("vector(1536)")?

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
  @@map("candidates")
}

// ============================================
// APPLICATION & PIPELINE
// ============================================

model Application {
  id               String            @id @default(uuid())
  status           ApplicationStatus @default(APPLIED)
  matchScore       Float?
  matchSummary     String?           @db.Text
  coverLetter      String?           @db.Text
  answers          Json?             // Screening question answers
  rejectionReason  String?
  withdrawalReason String?
  notes            String?           @db.Text
  appliedAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  currentStageId String?
  currentStage   PipelineStage? @relation(fields: [currentStageId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  interviews Interview[]
  offers     Offer[]
  activities ActivityLog[]
  onboarding OnboardingWorkflow?
  bgvChecks  BGVCheck[]

  @@unique([candidateId, jobId])
  @@index([jobId])
  @@index([candidateId])
  @@index([status])
  @@map("applications")
}

model Pipeline {
  id          String   @id @default(uuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stages PipelineStage[]
  jobs   Job[]

  @@index([tenantId])
  @@map("pipelines")
}

model PipelineStage {
  id          String   @id @default(uuid())
  name        String
  description String?
  order       Int
  color       String?
  slaDays     Int?     // Max days in this stage
  isTerminal  Boolean  @default(false) // Hired, Rejected, Withdrawn
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  pipelineId String
  pipeline   Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  applications Application[]
  automations  WorkflowAutomation[]

  @@index([pipelineId])
  @@map("pipeline_stages")
}

model WorkflowAutomation {
  id          String   @id @default(uuid())
  name        String
  description String?
  trigger     String   // e.g., "STAGE_ENTER", "STAGE_EXIT", "TIME_IN_STAGE"
  conditions  Json?    // Conditional logic
  actions     Json     // Actions to perform
  delayMinutes Int     @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stageId String
  stage   PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
  @@map("workflow_automations")
}

// ============================================
// INTERVIEWS
// ============================================

model Interview {
  id           String          @id @default(uuid())
  type         InterviewType
  status       InterviewStatus @default(SCHEDULED)
  scheduledAt  DateTime
  duration     Int             @default(60) // minutes
  location     String?
  meetingLink  String?
  notes        String?         @db.Text
  cancelReason String?
  reminderSent Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  interviewerId String
  interviewer   User   @relation(fields: [interviewerId], references: [id])

  feedbacks InterviewFeedback[]
  
  // Calendar Integration
  calendarEvents CalendarEvent[]

  @@index([applicationId])
  @@index([interviewerId])
  @@index([scheduledAt])
  @@map("interviews")
}

model InterviewFeedback {
  id          String   @id @default(uuid())
  rating      Int      // 1-5
  strengths   String?  @db.Text
  weaknesses  String?  @db.Text
  notes       String?  @db.Text
  recommendation String? // STRONG_YES, YES, NO, STRONG_NO
  scores      Json?    // Scorecard scores
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation(fields: [reviewerId], references: [id])

  @@unique([interviewId, reviewerId])
  @@index([interviewId])
  @@map("interview_feedbacks")
}

// ============================================
// COMMUNICATION (EMAIL)
// ============================================

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum EmailStatus {
  DRAFT
  SENT
  RECEIVED
  FAILED
}

model Email {
  id        String   @id @default(uuid())
  subject   String
  body      String   @db.Text
  from      String
  to        String
  cc        String?
  bcc       String?
  direction EmailDirection
  status    EmailStatus @default(DRAFT)
  sentAt    DateTime?
  receivedAt DateTime?
  messageId String?  // ID from provider
  threadId  String?  // Grouping ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?     @relation(fields: [userId], references: [id])

  attachments EmailAttachment[]

  @@index([candidateId])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
  @@map("emails")
}

model EmailAttachment {
  id        String   @id @default(uuid())
  filename  String
  url       String
  mimeType  String?
  size      Int?
  createdAt DateTime @default(now())

  emailId   String
  email     Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@map("email_attachments")
}

model EmailTemplate {
  id        String   @id @default(uuid())
  name      String
  subject   String
  body      String   @db.Text
  category  String?  // e.g. "Interview", "Rejection"
  isGlobal  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?     @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@map("email_templates")
}

// ============================================
// OFFERS
// ============================================

model Offer {
  id             String      @id @default(uuid())
  status         OfferStatus @default(DRAFT)
  content        String?     @db.Text
  salary         Decimal     @db.Decimal(12, 2)
  currency       String      @default("USD")
  bonus          Decimal?    @db.Decimal(12, 2)
  equity         String?
  startDate      DateTime?
  expiresAt      DateTime?
  letterUrl      String?
  signedLetterUrl String?
  notes          String?     @db.Text
  sentAt         DateTime?
  acceptedAt     DateTime?
  declinedAt     DateTime?
  declineReason  String?
  token          String?     @unique // For public access/signing
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  templateId     String?
  template       OfferTemplate? @relation(fields: [templateId], references: [id])

  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  approvals OfferApproval[]
  
  // E-Signature
  esignatureEnvelope ESignatureEnvelope?

  @@index([applicationId])
  @@index([status])
  @@map("offers")
}

model OfferApproval {
  id         String    @id @default(uuid())
  order      Int
  status     String    @default("PENDING")
  comment    String?
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  offerId    String
  offer      Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)
  approverId String
  approver   User   @relation("OfferApprover", fields: [approverId], references: [id])

  @@index([offerId])
  @@map("offer_approvals")
}

// ============================================
// ACTIVITY & AUDIT
// ============================================

model ActivityLog {
  id          String   @id @default(uuid())
  action      String   // e.g., "APPLICATION_CREATED", "STAGE_CHANGED", "CANDIDATE_CREATED"
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  candidateId String?
  candidate   Candidate? @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([candidateId])
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// SAVED VIEWS
// ============================================

model SavedView {
  id        String   @id @default(uuid())
  name      String
  entity    String   // e.g., "JOB", "CANDIDATE"
  filters   Json     // Store the filter state
  isShared  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@map("saved_views")
}
// ============================================
// SETTINGS
// ============================================

model Setting {
  id        String   @id @default(uuid())
  key       String
  value     Json
  category  String   @default("GENERAL") // GENERAL, NOTIFICATIONS, INTEGRATIONS, etc.
  isPublic  Boolean  @default(false)
  updatedAt DateTime @updatedAt
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("settings")
}

// ============================================
// SKILLS & TAXONOMY
// ============================================

model Skill {
  id          String   @id @default(uuid())
  name        String   // Canonical name (e.g., "React")
  synonyms    String[] // Synonyms (e.g., ["ReactJS", "React.js"])
  category    String?  // e.g., "Frontend", "Language"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("skills")
}

model AvailabilitySlot {
  id        String   @id @default(uuid())
  dayOfWeek Int      // 0=Sunday, 1=Monday, etc.
  startTime String   // "09:00"
  endTime   String   // "17:00"
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("availability_slots")
}

// ============================================
// ONBOARDING
// ============================================

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum OnboardingTaskStatus {
  PENDING
  COMPLETED
}

enum OnboardingAssigneeRole {
  CANDIDATE
  MANAGER
  IT
  HR
}

model OnboardingWorkflow {
  id            String           @id @default(uuid())
  status        OnboardingStatus @default(NOT_STARTED)
  startDate     DateTime
  progress      Float            @default(0) // Percentage 0-100
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenantId      String
  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  applicationId String           @unique
  application   Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  tasks         OnboardingTask[]

  @@index([tenantId])
  @@map("onboarding_workflows")
}

model OnboardingTask {
  id           String               @id @default(uuid())
  title        String
  description  String?
  assigneeRole OnboardingAssigneeRole
  status       OnboardingTaskStatus @default(PENDING)
  dueDate      DateTime?
  completedAt  DateTime?
  order        Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  workflowId   String
  workflow     OnboardingWorkflow   @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Document Collection
  isRequiredDoc   Boolean                  @default(false)
  documentUrl     String?
  documentStatus  OnboardingDocumentStatus @default(NOT_UPLOADED)

  @@index([workflowId])
  @@map("onboarding_tasks")
}

enum OnboardingDocumentStatus {
  NOT_UPLOADED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

// ============================================
// CALENDAR INTEGRATION
// ============================================

enum CalendarProvider {
  GOOGLE
  OUTLOOK
}

model CalendarConnection {
  id             String           @id @default(uuid())
  provider       CalendarProvider
  accessToken    String           @db.Text
  refreshToken   String?          @db.Text
  tokenExpiresAt DateTime?
  calendarId     String?
  email          String?
  isActive       Boolean          @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@map("calendar_connections")
}

model CalendarEvent {
  id          String           @id @default(uuid())
  externalId  String?
  provider    CalendarProvider
  title       String
  description String?          @db.Text
  startTime   DateTime
  endTime     DateTime
  location    String?
  meetingLink String?
  attendees   Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  interviewId String?
  interview   Interview? @relation(fields: [interviewId], references: [id], onDelete: SetNull)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([interviewId])
  @@index([startTime])
  @@map("calendar_events")
}

// ============================================
// E-SIGNATURE INTEGRATION
// ============================================

enum ESignatureProvider {
  DOCUSIGN
  ADOBE_SIGN
  ZOHO_SIGN
}

enum ESignatureStatus {
  CREATED
  SENT
  DELIVERED
  VIEWED
  SIGNED
  DECLINED
  VOIDED
  EXPIRED
}

model ESignatureEnvelope {
  id                String             @id @default(uuid())
  provider          ESignatureProvider @default(DOCUSIGN)
  externalId        String?
  status            ESignatureStatus   @default(CREATED)
  documentUrl       String?
  signedDocumentUrl String?
  signers           Json               @default("[]")
  sentAt            DateTime?
  viewedAt          DateTime?
  signedAt          DateTime?
  declinedAt        DateTime?
  declineReason     String?
  expiresAt         DateTime?
  webhookEvents     Json?              @default("[]")
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  offerId String @unique
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("esignature_envelopes")
}

model ESignatureSettings {
  id             String             @id @default(uuid())
  provider       ESignatureProvider @default(DOCUSIGN)
  clientId       String?
  clientSecret   String?            @db.Text
  accessToken    String?            @db.Text
  refreshToken   String?            @db.Text
  tokenExpiresAt DateTime?
  accountId      String?
  baseUrl        String?
  isConfigured   Boolean            @default(false)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("esignature_settings")
}

// ============================================
// BACKGROUND VERIFICATION (BGV)
// ============================================

enum BGVProvider {
  CHECKR
  SPRINGVERIFY
  AUTHBRIDGE
  MANUAL
}

enum BGVStatus {
  PENDING
  INITIATED
  IN_PROGRESS
  COMPLETED
  CLEAR
  CONSIDER
  FAILED
  CANCELLED
}

enum BGVCheckType {
  IDENTITY
  CRIMINAL
  EDUCATION
  EMPLOYMENT
  CREDIT
  DRUG_TEST
  REFERENCE
  ADDRESS
}

model BGVCheck {
  id              String         @id @default(uuid())
  provider        BGVProvider
  externalId      String?        // Provider's check ID
  status          BGVStatus      @default(PENDING)
  packageType     String?        // e.g., "basic", "standard", "comprehensive"
  checkTypes      BGVCheckType[]
  reportUrl       String?
  result          Json?          // Full result from provider
  discrepancies   Json?          // Any flagged issues
  initiatedAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id])

  initiatedById String?
  initiatedBy   User?   @relation(fields: [initiatedById], references: [id])

  @@index([candidateId])
  @@index([applicationId])
  @@index([status])
  @@map("bgv_checks")
}

model BGVSettings {
  id           String      @id @default(uuid())
  provider     BGVProvider @default(CHECKR)
  apiKey       String?     @db.Text
  apiSecret    String?     @db.Text
  webhookUrl   String?
  isConfigured Boolean     @default(false)
  sandboxMode  Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("bgv_settings")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  APPLICATION
  INTERVIEW
  OFFER
  JOB
  SLA
  APPROVAL
  ONBOARDING
  BGV
  SYSTEM
  MESSAGE
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  read      Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())

  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tenantId String

  @@index([userId])
  @@index([tenantId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id                    String  @id @default(uuid())
  
  // Application notifications
  newApplication        Boolean @default(true)
  applicationStageChange Boolean @default(true)
  
  // Interview notifications
  interviewScheduled    Boolean @default(true)
  interviewReminder     Boolean @default(true)
  interviewFeedback     Boolean @default(true)
  
  // Offer notifications
  offerCreated          Boolean @default(true)
  offerApproval         Boolean @default(true)
  offerAccepted         Boolean @default(true)
  offerDeclined         Boolean @default(true)
  
  // Job notifications
  jobApproval           Boolean @default(true)
  jobPublished          Boolean @default(true)
  
  // SLA notifications
  slaAtRisk             Boolean @default(true)
  slaOverdue            Boolean @default(true)
  
  // Other notifications
  approvalRequests      Boolean @default(true)
  onboardingUpdates     Boolean @default(true)
  bgvUpdates            Boolean @default(true)
  systemAlerts          Boolean @default(true)
  
  // Delivery preferences
  emailEnabled          Boolean @default(true)
  pushEnabled           Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// EMAIL TRACKING
// ============================================

model EmailTrackingEvent {
  id           String   @id @default(uuid())
  campaignId   String
  candidateId  String
  eventType    String   // OPEN, CLICK, REPLY, BOUNCE, UNSUBSCRIBE
  eventData    Json?    // Additional data like clicked URL, bounce reason, etc.
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  tenantId     String

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([candidateId])
  @@index([eventType])
  @@index([tenantId])
  @@index([createdAt])
  @@map("email_tracking_events")
}

model EmailTrackingLink {
  id            String   @id @default(uuid())
  campaignId    String
  originalUrl   String
  trackingToken String   @unique
  createdAt     DateTime @default(now())

  @@index([campaignId])
  @@map("email_tracking_links")
}

// ============================================
// SUPER ADMIN (Platform-Level)
// ============================================

enum SuperAdminStatus {
  ACTIVE
  LOCKED
  DISABLED
}

model SuperAdmin {
  id              String           @id @default(uuid())
  email           String           @unique
  passwordHash    String
  requirePasswordChange Boolean     @default(false)
  name            String
  status          SuperAdminStatus @default(ACTIVE)
  mfaEnabled      Boolean          @default(false)
  mfaSecret       String?
  lastLoginAt     DateTime?
  lastLoginIp     String?
  failedAttempts  Int              @default(0)
  lockedUntil     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Refresh tokens
  refreshTokens SuperAdminRefreshToken[]

  // Audit logs
  auditLogs SuperAdminAuditLog[]
  supportMessages SupportTicketMessage[]
  
  // Notifications
  notifications SuperAdminNotification[]
  
  @@index([email])
  @@index([status])
  @@map("super_admins")
}

model GlobalSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  category  String?  // general, email, security, features
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@map("global_settings")
}

model SuperAdminRefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@map("super_admin_refresh_tokens")
}

model SuperAdminAuditLog {
  id           String   @id @default(uuid())
  action       String   // LOGIN, LOGOUT, VIEW_TENANT, SUSPEND_TENANT, etc.
  entityType   String?  // TENANT, USER, SUBSCRIPTION, etc.
  entityId     String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])

  @@map("super_admin_audit_logs")
}

// ============================================
// SUPER ADMIN NOTIFICATIONS
// ============================================

enum SuperAdminNotificationType {
  SYSTEM          // System alerts (health, errors)
  SECURITY        // Security alerts (blocked IPs, failed logins)
  TENANT          // Tenant-related (new signup, suspension)
  SUBSCRIPTION    // Billing/subscription events
  SUPPORT         // New support tickets
  ANNOUNCEMENT    // Announcement-related
  USER            // User-related events
}

enum SuperAdminNotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model SuperAdminNotification {
  id        String                         @id @default(uuid())
  type      SuperAdminNotificationType
  priority  SuperAdminNotificationPriority @default(MEDIUM)
  title     String
  message   String                         @db.Text
  link      String?                        // Optional link to related resource
  metadata  Json?                          // Additional context data
  read      Boolean                        @default(false)
  readAt    DateTime?
  createdAt DateTime                       @default(now())

  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@index([superAdminId])
  @@index([read])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("super_admin_notifications")
}

// ============================================
// ADVANCED SUPER ADMIN ENTITIES
// ============================================

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String   @db.Text
  type      String   // info, warning, success, critical
  priority  String   @default("medium") // low, medium, high
  status    String   // draft, scheduled, active, expired
  audience  String   @default("all") // all, admins, specific_tenants
  targetTenantIds String[] // Array of tenant IDs
  dismissible Boolean @default(true)
  showBanner Boolean @default(false)
  scheduledAt DateTime?
  expiresAt DateTime?
  publishedAt DateTime?
  authorId  String
  viewCount Int      @default(0)
  dismissCount Int   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  readBy    AnnouncementReadStatus[]

  @@map("announcements")
}

model AnnouncementReadStatus {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  readAt         DateTime     @default(now())
  isDismissed    Boolean      @default(false)

  @@unique([userId, announcementId])
  @@map("announcement_read_status")
}

model SupportTicket {
  id        String   @id @default(uuid())
  subject   String
  description String @db.Text
  status    String   // open, in_progress, resolved, closed
  priority  String   // low, medium, high, urgent
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  assignedToId String? // Super admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  messages  SupportTicketMessage[]
  
  @@map("support_tickets")
}

model SupportTicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId  String?
  sender    User?    @relation(fields: [senderId], references: [id])
  adminId   String?
  admin     SuperAdmin? @relation(fields: [adminId], references: [id])
  message   String   @db.Text
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  
  @@map("support_ticket_messages")
}

model SecurityAlert {
  id        String   @id @default(uuid())
  type      String   // BRUTE_FORCE, UNUSUAL_LOCATION, MFA_FAILURE, etc.
  severity  String   // low, medium, high, critical
  message   String
  metadata  Json?    // Detailed event data (e.g., userAgent, location)
  sourceIp  String?
  tenantId  String?
  userId    String?
  status    String   @default("OPEN") // OPEN, RESOLVED, IGNORED, FALSE_POSITIVE
  createdAt DateTime @default(now())
  resolvedAt DateTime?
  resolvedById String? // Super admin ID
  
  @@index([status])
  @@index([createdAt])
  @@map("security_alerts")
}

model BlockedIp {
  id        String   @id @default(uuid())
  ipAddress String   @unique
  reason    String?
  blockedAt DateTime @default(now())
  expiresAt DateTime?
  blockedBy String?
  
  @@map("blocked_ips")
}

model ApiKey {
  id        String   @id @default(uuid())
  name      String
  key       String   @unique
  scopes    String[]
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  isActive  Boolean  @default(true)
  lastUsedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  
  @@map("api_keys")
}

model WebhookSubscription {
  id          String   @id @default(uuid())
  url         String
  events      String[] // e.g., ["candidate.created", "job.updated"]
  secret      String   // Webhook secret for signing payloads
  isActive    Boolean  @default(true)
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("webhook_subscriptions")
}

model ApiUsage {
  id          String   @id @default(uuid())
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  endpoint    String
  method      String
  status      Int
  duration    Int      // in ms
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([createdAt])
  @@map("api_usage")
}

model SystemMetric {
  id        String   @id @default(uuid())
  type      String   // CPU, MEMORY, DISK, LATENCY, REQ_RATE, ERROR_RATE
  value     Float
  unit      String   // PERCENT, MB, MS, COUNT
  label     String?  // Optional label (e.g., core ID, endpoint)
  timestamp DateTime @default(now())

  @@index([type, timestamp])
  @@map("system_metrics")
}

model SystemLog {
  id        String   @id @default(uuid())
  level     String   // info, warn, error, fatal
  message   String   @db.Text
  stack     String?  @db.Text
  context   String?  // The component/service that logged it
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([createdAt])
  @@map("system_logs")
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String   @unique // STARTER, PROFESSIONAL, ENTERPRISE
  displayName   String
  description   String?
  monthlyPrice  Int      // in cents
  yearlyPrice   Int      // in cents
  currency      String   @default("USD")
  features      Json     @default("[]")
  limits        Json     @default("{}") // { users: 5, jobs: 10, candidates: 500 }
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                 String             @id @default(uuid())
  status             SubscriptionStatus @default(TRIAL)
  billingCycle       BillingCycle       @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEndsAt        DateTime?
  cancelledAt        DateTime?
  cancelReason       String?
  stripeSubscriptionId String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  tenantId String   @unique
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  payments Payment[]
  invoices Invoice[]

  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model Payment {
  id            String   @id @default(uuid())
  amount        Float
  currency      String
  status        String
  stripePaymentId String?
  subscriptionId String
  subscription  Subscription @relation(fields: [subscriptionId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("payments")
}

model Invoice {
  id          String   @id @default(uuid())
  amount      Float
  currency    String
  status      String   // paid, open, void, uncollectible
  stripeInvoiceId String? @unique
  pdfUrl      String?
  periodStart DateTime
  periodEnd   DateTime
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("invoices")
}

model PaymentGatewayConfig {
  id          String   @id @default(uuid())
  provider    String   // STRIPE, GPAY, PAYTM
  isActive    Boolean  @default(false)
  config      Json     // encrypted keys: apiKey, secretKey, merchantId, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider])
  @@map("payment_gateway_configs")
}

